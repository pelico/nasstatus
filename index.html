<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAS 实时状态监控</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background: #1e1e1e;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        h1, h2 {
            text-align: center;
            color: #bb86fc;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }
        h2 {
            font-size: 1.5em;
            margin-top: 40px;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .metric-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .metric-label {
            font-size: 1em;
            color: #a0a0a0;
            margin-bottom: 10px;
            display: block;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #03dac6;
            font-family: "Courier New", Courier, monospace;
        }
        .metric-value.small-font {
            font-size: 1.2em;
        }
        .metric-subvalue {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-top: 5px;
        }
        .progress-bar-container {
            width: 100%;
            background-color: #444;
            border-radius: 5px;
            margin-top: 10px;
            height: 10px;
        }
        .progress-bar {
            height: 100%;
            background-color: #03dac6;
            border-radius: 5px;
            width: 0%; /* Default width */
            transition: width 0.5s ease-in-out;
        }
        #status-footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.8em;
            color: #666;
        }
        .error { color: #cf6679; }
    </style>
</head>
<body>
    <div class="container">
        <h1>NAS 实时状态监控</h1>
        <div class="grid-container">
            <div class="metric-card">
                <span class="metric-label">CPU 使用率</span>
                <div class="metric-value" id="cpu-usage">-- %</div>
            </div>
            <div class="metric-card">
                <span class="metric-label">内存使用率</span>
                <div class="metric-value" id="mem-usage">-- %</div>
                <div class="metric-subvalue" id="mem-details">-- / -- MB</div>
            </div>
            <div class="metric-card">
                <span class="metric-label">下载速度</span>
                <div class="metric-value" id="net-down">-- MB/s</div>
            </div>
            <div class="metric-card">
                <span class="metric-label">上传速度</span>
                <div class="metric-value" id="net-up">-- MB/s</div>
            </div>
            <div class="metric-card">
                <span class="metric-label">系统运行时间</span>
                <div class="metric-value small-font" id="system-uptime">--</div>
            </div>
            <div class="metric-card">
                <span class="metric-label">系统开机时间</span>
                <div class="metric-value small-font" id="boot-time">--</div>
            </div>
        </div>
        
        <!-- 新增硬盘空间部分 -->
        <h2 id="disk-title" style="display:none;">硬盘空间</h2>
        <div class="grid-container" id="disk-info-container">
            <!-- 硬盘信息将由JS动态插入这里 -->
        </div>

        <div id="status-footer">
            <span id="status-text">正在连接...</span>
            <span id="error-text" class="error"></span>
        </div>
    </div>

    <script>
        // ##################################################################
        // #                       !!! 用户配置区 !!!                       #
        // ##################################################################
        const WORKER_URL = 'https://nas-hook.111312.xyz';
        const TARGET_INTERFACES = ['eth0', 'wlan0'];

        // 忽略这些类型的文件系统，避免显示系统临时分区
        const EXCLUDED_FILESYSTEM_TYPES = new Set([
            'tmpfs', 'devtmpfs', 'devfs', 'iso9660', 'squashfs', 'udf', 'vfat'
        ]);
        // ##################################################################
        
        let previousCpuData = null, previousNetData = null, lastFetchTime = null, bootTimestamp = 0;

        function formatBytes(bytes, decimals = 2) {
            if (bytes <= 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSecond, decimals = 2) {
             if (bytesPerSecond < 1) return '0 B/s';
            const k = 1024;
            const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s', 'TB/s'];
            const i = Math.floor(Math.log(bytesPerSecond) / Math.log(k));
            return parseFloat((bytesPerSecond / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
        }
        
        function formatUptime(totalSeconds) {
            if (totalSeconds <= 0) return '计算中...';
            totalSeconds = Math.floor(totalSeconds);
            const days = Math.floor(totalSeconds / 86400);
            totalSeconds %= 86400;
            const hours = Math.floor(totalSeconds / 3600);
            totalSeconds %= 3600;
            const minutes = Math.floor(totalSeconds / 60);
            let parts = [];
            if (days > 0) parts.push(`${days} 天`);
            if (hours > 0) parts.push(`${hours} 小时`);
            if (minutes > 0) parts.push(`${minutes} 分钟`);
            if (parts.length === 0 && totalSeconds > 0) return `${totalSeconds} 秒`;
            return parts.join(' ');
        }

        function parseMetrics(text) {
            const metrics = {
                cpu: { total: 0, idle: 0 },
                memory: { total: 0, available: 0 },
                network: { received: 0, transmitted: 0 },
                bootTime: 0,
                filesystems: {}
            };

            const lines = text.split('\n');
            for (const line of lines) {
                if (line.startsWith('#')) continue;
                
                const parts = line.split(' ');
                const value = parseFloat(parts[1]);

                if (line.startsWith('node_cpu_seconds_total')) {
                    metrics.cpu.total += value;
                    if (line.includes('mode="idle"')) metrics.cpu.idle += value;
                }
                else if (line.startsWith('node_memory_MemTotal_bytes')) metrics.memory.total = value;
                else if (line.startsWith('node_memory_MemAvailable_bytes')) metrics.memory.available = value;
                else if (line.startsWith('node_network_receive_bytes_total') || line.startsWith('node_network_transmit_bytes_total')) {
                    const isReceive = line.startsWith('node_network_receive_bytes_total');
                    const interfaceMatch = line.match(/device="([^"]+)"/);
                    if (interfaceMatch && TARGET_INTERFACES.includes(interfaceMatch[1])) {
                        if (isReceive) metrics.network.received += value;
                        else metrics.network.transmitted += value;
                    }
                }
                else if (line.startsWith('node_boot_time_seconds')) metrics.bootTime = value;
                else if (line.startsWith('node_filesystem_')) {
                    const fstypeMatch = line.match(/fstype="([^"]+)"/);
                    const mountpointMatch = line.match(/mountpoint="([^"]+)"/);
                    if (fstypeMatch && mountpointMatch && !EXCLUDED_FILESYSTEM_TYPES.has(fstypeMatch[1])) {
                        const mountpoint = mountpointMatch[1];
                        if (!metrics.filesystems[mountpoint]) metrics.filesystems[mountpoint] = {};
                        if (line.startsWith('node_filesystem_size_bytes')) metrics.filesystems[mountpoint].size = value;
                        if (line.startsWith('node_filesystem_avail_bytes')) metrics.filesystems[mountpoint].avail = value;
                    }
                }
            }
            return metrics;
        }
        
        // 新增：更新硬盘信息的函数
        function updateDiskDisplay(filesystems) {
            const container = document.getElementById('disk-info-container');
            const title = document.getElementById('disk-title');
            container.innerHTML = ''; // 清空旧数据
            
            const fsEntries = Object.entries(filesystems);

            if (fsEntries.length > 0) {
                 title.style.display = 'block';
            } else {
                 title.style.display = 'none';
                 return;
            }

            for (const [mountpoint, data] of fsEntries) {
                if (data.size > 0 && data.avail !== undefined) {
                    const total = data.size;
                    const available = data.avail;
                    const used = total - available;
                    const usagePercent = (used / total) * 100;
                    
                    const cardHTML = `
                        <div class="metric-card">
                            <span class="metric-label">硬盘 (${mountpoint})</span>
                            <div class="metric-value">${usagePercent.toFixed(1)} %</div>
                            <div class="metric-subvalue">${formatBytes(used, 1)} / ${formatBytes(total, 1)}</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${usagePercent.toFixed(1)}%;"></div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += cardHTML;
                }
            }
        }

        async function fetchData() {
            const statusText = document.getElementById('status-text');
            const errorText = document.getElementById('error-text');
            
            try {
                const response = await fetch(WORKER_URL);
                if (!response.ok) throw new Error(`请求失败: ${response.status} ${response.statusText}`);
                const text = await response.text();
                const now = Date.now();
                const currentMetrics = parseMetrics(text);
                
                // CPU
                if (previousCpuData) {
                    const totalDiff = currentMetrics.cpu.total - previousCpuData.total;
                    const idleDiff = currentMetrics.cpu.idle - previousCpuData.idle;
                    const usage = totalDiff > 0 ? 100 * (1 - (idleDiff / totalDiff)) : 0;
                    document.getElementById('cpu-usage').textContent = `${usage.toFixed(1)} %`;
                }
                
                // 内存
                const memTotalMB = (currentMetrics.memory.total / 1024 / 1024);
                const memAvailableMB = (currentMetrics.memory.available / 1024 / 1024);
                const memUsedMB = memTotalMB - memAvailableMB;
                const memUsagePercent = memTotalMB > 0 ? (memUsedMB / memTotalMB) * 100 : 0;
                document.getElementById('mem-usage').textContent = `${memUsagePercent.toFixed(1)} %`;
                document.getElementById('mem-details').textContent = `${memUsedMB.toFixed(0)} / ${memTotalMB.toFixed(0)} MB`;
                
                // 网络
                if (previousNetData && lastFetchTime) {
                    const timeDelta = (now - lastFetchTime) / 1000;
                    const downBytesDiff = currentMetrics.network.received - previousNetData.received;
                    const upBytesDiff = currentMetrics.network.transmitted - previousNetData.transmitted;
                    document.getElementById('net-down').textContent = formatSpeed(downBytesDiff / timeDelta);
                    document.getElementById('net-up').textContent = formatSpeed(upBytesDiff / timeDelta);
                }
                
                // 开机和运行时间
                if (currentMetrics.bootTime > 0) {
                    bootTimestamp = currentMetrics.bootTime;
                    const bootDate = new Date(bootTimestamp * 1000);
                    document.getElementById('boot-time').textContent = bootDate.toLocaleString('zh-CN', { dateStyle: 'medium', timeStyle: 'short' });
                }
                
                // 调用硬盘更新函数
                updateDiskDisplay(currentMetrics.filesystems);

                previousCpuData = currentMetrics.cpu;
                previousNetData = currentMetrics.network;
                lastFetchTime = now;
                
                statusText.textContent = `上次更新: ${new Date().toLocaleTimeString()}`;
                errorText.textContent = '';
            } catch (error) {
                console.error('获取NAS状态失败:', error);
                errorText.textContent = `错误: ${error.message}`;
            }
        }
        
        function updateUptimeDisplay() {
            if (bootTimestamp > 0) {
                const uptimeSeconds = (Date.now() / 1000) - bootTimestamp;
                document.getElementById('system-uptime').textContent = formatUptime(uptimeSeconds);
            }
        }

        fetchData();
        setInterval(fetchData, 5000);
        setInterval(updateUptimeDisplay, 1000);
    </script>
</body>
</html>
